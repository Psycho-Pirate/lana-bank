with

customers as(
    select *
    from {{ ref('int_sumsub_applicants') }}
)

, statuses as(
    select
        ref.* except (customer_id, disbursal_id),
        coalesce(dias_mora_k, 0) as days_past_due_on_principal,
        coalesce(dias_mora_i, 0) as days_past_due_on_interest,
        greatest(coalesce(dias_mora_k, 0), coalesce(dias_mora_i, 0)) as payment_overdue_days,
        estado,
        `explicación`,
        status,
        explanation,
    from {{ ref('int_nrp_41_02_referencia') }} as ref
    left join {{ ref('static_nrp_41_estados_del_préstamo') }} on greatest(coalesce(dias_mora_k, 0), coalesce(dias_mora_i, 0)) between consumer_calendar_ge_days and consumer_calendar_le_days
)

, loans as(
    select
        credit_facility_id as line_of_credit,
        disbursal_id as disbursement_number,
        disbursal_start_date as disbursement_date,
        annual_rate as interest_rate,
        customer_id,
        first_name || ' ' || last_name as customer_name,
        total_disbursed_usd as disbursed_amount,
        disbursal_end_date as maturity_date,

        days_past_due_on_principal,
        days_past_due_on_interest,
        payment_overdue_days,
        coalesce(estado, 'Cancelado') as estado,
        `explicación`,
        coalesce(status, 'Canceled') as status,
        explanation,

        disbursal_start_date as date_and_time,
        'Disbursement' as transaction,
        total_disbursed_usd as principal,
        null as interest,
        null as fee,
        null as vat,
        total_disbursed_usd as total_transaction,
    from {{ ref('int_approved_credit_facility_loans') }}
    left join customers using(customer_id)
    left join statuses using(credit_facility_id)
)

, risk as(
    select *
    from {{ ref('int_net_risk_calculation') }} as ref
)

, final as (
    select *
    from loans
    left join risk using (line_of_credit, disbursement_number)
)

select
    line_of_credit as line_of_credit_no,
    disbursement_number,
    1 as product_code,
    'PRESTAMOS GARANTIZADOS CON BITCOIN' as product,
    customer_id as customer_code,
    customer_name,
    disbursement_date,
    maturity_date,
    status,
    interest_rate,
    interest_rate as effective_rate,
    disbursed_amount,
    principal_balance,
    0 as interest_balance,
    days_past_due_on_principal,
    days_past_due_on_interest,
    payment_overdue_days / 30 as number_of_past_due_installments,
    'Privado' as type_of_credit,
    category_b as risk_rating,
    'Automática' as category_assignment_type,
    100 * guarantee_amount / coalesce(principal_balance, 1) as percentage_guaranteed,
    net_risk,
    reserve as reserve_amount,
    '1141030101' as capital_account,
    '1141039901' as interest_account,
from final
